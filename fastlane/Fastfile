require 'dotenv'

Dotenv.load

lane :beta do |options|
  build
  pilot(
    ipa:  "build/Glowb.ipa",
    app_identifier: ENV['APP_IDENTIFIER'],
    username: ENV['APPLE_USERNAME'],
    skip_waiting_for_build_processing: true,
  )
end

private_lane :build do |options|
  certs
  increment_build_number
  gym(
    verbose: true,
    include_bitcode: true,
    include_symbols: true,
    scheme: "Glowb",
    output_directory: "build",
    export_options: {
      thinning: "<thin-for-all-variants>"
    }
  )
end

lane :certs do
  ['development', 'appstore'].each do |env|
    match(type: env)
  end
end

#----- Certificates / Provisioning -----#
lane :add_devices do |options|
  raise "no device name specified" unless options[:names]
  raise "no device udid specified" unless options[:udids]

  system("./add_devices.rb #{options[:names]} #{options[:udids]}", out: $stdout, err: :out)

  update_profiles
end

private_lane :update_profiles do |options|
  system("./update_profiles.rb", out: $stdout, err: :out)
end

